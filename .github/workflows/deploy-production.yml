name: Deploy Production

on:
  push:
    branches: ['back-end']
  pull_request:
    branches: ['back-end']

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build docker image
        run: docker build --platform linux/amd64 -t caophi562005/pixcam-server:v1 .

      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      - name: Push docker image to DockerHub
        run: docker push caophi562005/pixcam-server:v1

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST_PRODUCTION }}
          username: ${{ secrets.USERNAME_PRODUCTION }}
          password: ${{ secrets.PASSWORD_PRODUCTION }}
          port: ${{ secrets.PORT_PRODUCTION }}
          script: |
            set -e  # Dá»«ng láº¡i ngay khi cÃ³ lá»—i

            echo "ğŸš€ Báº¯t Ä‘áº§u quÃ¡ trÃ¬nh triá»ƒn khai..."

            # Táº¡o thÆ° má»¥c dá»± Ã¡n náº¿u chÆ°a tá»“n táº¡i
            PROJECT_DIR="$HOME/pixcam-server"
            mkdir -p $PROJECT_DIR
            cd $PROJECT_DIR

            # ÄÄƒng nháº­p vÃ o DockerHub trÃªn server
            echo "ğŸ“¥ ÄÄƒng nháº­p DockerHub..."
            echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

            # KÃ©o image má»›i nháº¥t
            echo "ğŸ“¦ KÃ©o image Docker má»›i nháº¥t..."
            docker pull caophi562005/pixcam-server:v1

            # Dá»n dáº¹p cÃ¡c image cÅ© khÃ´ng dÃ¹ng Ä‘áº¿n
            echo "ğŸ§¹ Dá»n dáº¹p image cÅ©..."
            docker image prune -f

            echo "ğŸ”„ Dá»«ng container cÅ©..."
            docker stop pixcam-server 2>/dev/null || echo "No container to stop"
            docker rm pixcam-server 2>/dev/null || echo "No container to remove"

            # Táº¡o tá»‡p .env má»›i tá»« GitHub Secrets
            echo "âš™ï¸ Táº¡o tá»‡p .env..."
            cat <<EOF > .env
            ${{ secrets.ENV_PRODUCTION }}
            EOF
            echo "âœ… ÄÃ£ táº¡o tá»‡p .env thÃ nh cÃ´ng."

            # Táº¡o tá»‡p docker-compose.yml
            echo "âš™ï¸ Táº¡o tá»‡p docker-compose.yml..."
            cat <<'EOF' > docker-compose.yml
            version: '3.8'
            services:
              pixcam-server:
                image: caophi562005/pixcam-server:v1
                container_name: pixcam-server
                restart: unless-stopped
                ports:
                  - "3000:3000"
                env_file:
                  - .env
            EOF
            echo "âœ… ÄÃ£ táº¡o tá»‡p docker-compose.yml thÃ nh cÃ´ng."

            # Dá»«ng vÃ  khá»Ÿi Ä‘á»™ng láº¡i dá»‹ch vá»¥ báº±ng Docker Compose
            # Lá»‡nh 'up -d' sáº½ tá»± Ä‘á»™ng dá»«ng vÃ  táº¡o láº¡i container náº¿u cáº¥u hÃ¬nh hoáº·c image thay Ä‘á»•i
            echo "ğŸš€ Khá»Ÿi Ä‘á»™ng container báº±ng Docker Compose..."
            docker-compose up -d

            echo "ğŸ‰ QuÃ¡ trÃ¬nh triá»ƒn khai hoÃ n táº¥t thÃ nh cÃ´ng!"
