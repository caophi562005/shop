name: Deploy Production

on:
  push:
    branches: ['back-end']
  pull_request:
    branches: ['back-end']

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build docker image
        run: docker build --platform linux/amd64 -t caophi562005/pixcam-server:v1 .

      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      - name: Push docker image to DockerHub
        run: docker push caophi562005/pixcam-server:v1

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST_PRODUCTION_2 }}
          username: ${{ secrets.USERNAME_PRODUCTION }}
          password: ${{ secrets.PASSWORD_PRODUCTION }}
          port: ${{ secrets.PORT_PRODUCTION }}
          script: |
            set -e  # D·ª´ng l·∫°i ngay khi c√≥ l·ªói

            echo "üöÄ B·∫Øt ƒë·∫ßu qu√° tr√¨nh tri·ªÉn khai..."

            # T·∫°o th∆∞ m·ª•c d·ª± √°n n·∫øu ch∆∞a t·ªìn t·∫°i
            PROJECT_DIR="$HOME/pixcam-project"
            mkdir -p $PROJECT_DIR
            cd $PROJECT_DIR

            # ƒêƒÉng nh·∫≠p v√†o DockerHub tr√™n server
            echo "üì• ƒêƒÉng nh·∫≠p DockerHub..."
            echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

            # K√©o image m·ªõi nh·∫•t
            echo "üì¶ K√©o image Docker m·ªõi nh·∫•t..."
            docker pull caophi562005/pixcam-server:v1

            # D·ªçn d·∫πp c√°c image c≈© kh√¥ng d√πng ƒë·∫øn
            echo "üßπ D·ªçn d·∫πp image c≈©..."
            docker image prune -f

            # T·∫°o t·ªáp .env m·ªõi t·ª´ GitHub Secrets
            echo "‚öôÔ∏è T·∫°o t·ªáp .env..."
            cat <<EOF > .env
            ${{ secrets.ENV_PRODUCTION }}
            EOF
            echo "‚úÖ ƒê√£ t·∫°o t·ªáp .env th√†nh c√¥ng."

            # T·∫°o t·ªáp docker-compose.yml
            echo "‚öôÔ∏è T·∫°o t·ªáp docker-compose.yml..."
            cat <<'EOF' > docker-compose.yml
            version: '3.8'
            services:
              pixcam-server:
                image: caophi562005/pixcam-server:v1
                container_name: pixcam-server
                restart: unless-stopped
                ports:
                  - "3000:3000"
                env_file:
                  - .env
            EOF
            echo "‚úÖ ƒê√£ t·∫°o t·ªáp docker-compose.yml th√†nh c√¥ng."

            # D·ª´ng v√† kh·ªüi ƒë·ªông l·∫°i d·ªãch v·ª• b·∫±ng Docker Compose
            # L·ªánh 'up -d' s·∫Ω t·ª± ƒë·ªông d·ª´ng v√† t·∫°o l·∫°i container n·∫øu c·∫•u h√¨nh ho·∫∑c image thay ƒë·ªïi
            echo "üöÄ Kh·ªüi ƒë·ªông container b·∫±ng Docker Compose..."
            docker-compose up -d

            echo "üéâ Qu√° tr√¨nh tri·ªÉn khai ho√†n t·∫•t th√†nh c√¥ng!"
