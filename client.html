<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Messenger-like Chat</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      /* CSS ƒë·ªÉ giao di·ªán tr√¥ng gi·ªëng Messenger */
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        display: flex;
        height: 100vh;
        margin: 0;
        background-color: #f0f2f5;
        justify-content: center;
        align-items: center;
      }
      #auth-container,
      #chat-container {
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #chat-container {
        display: none;
        width: 400px;
        height: 600px;
        flex-direction: column;
      }
      #chat-box {
        flex-grow: 1;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      .message {
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 18px;
        line-height: 1.4;
        max-width: 75%;
        word-wrap: break-word;
      }
      .sent {
        background-color: #0084ff;
        color: white;
        align-self: flex-end;
      }
      .received {
        background-color: #e4e6eb;
        color: black;
        align-self: flex-start;
      }
      #chat-form {
        display: flex;
      }
      #message-input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 18px;
        outline: none;
      }
      button {
        padding: 10px 15px;
        border-radius: 18px;
        border: none;
        background-color: #0084ff;
        color: white;
        cursor: pointer;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div id="auth-container">
      <h2>B·∫Øt ƒë·∫ßu chat</h2>
      <p>Nh·∫≠p ID c·ªßa b·∫°n v√† ng∆∞·ªùi mu·ªën chat:</p>
      <input type="number" id="my-user-id" placeholder="ID c·ªßa b·∫°n (e.g., 1)" />
      <input type="number" id="to-user-id" placeholder="ID ng∆∞·ªùi nh·∫≠n (e.g., 2)" />
      <button id="connect-btn">V√†o Chat</button>
    </div>

    <div id="chat-container">
      <h3 id="chat-title"></h3>
      <div id="chat-box"></div>
      <form id="chat-form">
        <input id="message-input" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off" />
        <button type="submit">G·ª≠i</button>
      </form>
    </div>

    <script>
      // L·∫•y c√°c ph·∫ßn t·ª≠ tr√™n trang HTML.
      const authContainer = document.getElementById('auth-container')
      const chatContainer = document.getElementById('chat-container')
      const connectBtn = document.getElementById('connect-btn')
      const myUserIdInput = document.getElementById('my-user-id')
      const toUserIdInput = document.getElementById('to-user-id')
      const chatForm = document.getElementById('chat-form')
      const messageInput = document.getElementById('message-input')
      const chatBox = document.getElementById('chat-box')
      const chatTitle = document.getElementById('chat-title')

      // Bi·∫øn ƒë·ªÉ l∆∞u tr·∫°ng th√°i c·ªßa ·ª©ng d·ª•ng.
      let socket
      let myUserId
      let toUserId

      // H√†m g·ªçi API ƒë·ªÉ l·∫•y l·ªãch s·ª≠ tin nh·∫Øn.
      async function fetchChatHistory(otherUserId) {
        // Thay ƒë·ªïi URL n·∫øu server API c·ªßa b·∫°n ch·∫°y ·ªü port kh√°c (v√≠ d·ª•: 3000).
        const response = await fetch(`http://localhost:3000/messages/${otherUserId}`)
        if (!response.ok) {
          alert('Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ tin nh·∫Øn.')
          return []
        }
        // Tr·∫£ v·ªÅ d·ªØ li·ªáu JSON t·ª´ API.
        return response.json()
      }

      // H√†m ƒë·ªÉ hi·ªÉn th·ªã m·ªôt tin nh·∫Øn l√™n khung chat.
      function displayMessage(message) {
        const messageElement = document.createElement('div')
        messageElement.classList.add('message')
        messageElement.innerText = message.content

        // Ki·ªÉm tra xem tin nh·∫Øn n√†y l√† g·ª≠i ƒëi hay nh·∫≠n v·ªÅ ƒë·ªÉ th√™m class CSS ph√π h·ª£p.
        if (message.fromUserId === myUserId) {
          messageElement.classList.add('sent')
        } else {
          messageElement.classList.add('received')
        }

        chatBox.appendChild(messageElement)
      }

      // H√†m ƒë·ªÉ t·ª± ƒë·ªông cu·ªôn xu·ªëng cu·ªëi khung chat.
      function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight
      }

      // H√†m ƒë·ªÉ thi·∫øt l·∫≠p k·∫øt n·ªëi WebSocket.
      function connectWebSocket() {
        // Thay ƒë·ªïi URL n·∫øu server WebSocket ch·∫°y ·ªü port kh√°c (v√≠ d·ª•: 8081).
        // Truy·ªÅn `userId` qua query ƒë·ªÉ server x√°c th·ª±c.
        socket = io('http://localhost:8081', { query: { userId: myUserId } })

        // L·∫Øng nghe c√°c s·ª± ki·ªán t·ª´ WebSocket.
        socket.on('connect', () => console.log('‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket!'))
        socket.on('disconnect', () => console.log('‚ùå ƒê√£ ng·∫Øt k·∫øt n·ªëi WebSocket.'))

        // L·∫Øng nghe s·ª± ki·ªán 'newMessage' cho c√°c tin nh·∫Øn real-time.
        socket.on('newMessage', (message) => {
          console.log('üì© C√≥ tin nh·∫Øn m·ªõi:', message)
          // Ch·ªâ hi·ªÉn th·ªã n·∫øu tin nh·∫Øn thu·ªôc cu·ªôc h·ªôi tho·∫°i ƒëang m·ªü.
          if (message.fromUserId === toUserId || message.fromUserId === myUserId) {
            displayMessage(message)
            scrollToBottom()
          }
        })
      }

      // G·∫Øn s·ª± ki·ªán 'click' cho n√∫t "V√†o Chat".
      connectBtn.addEventListener('click', async () => {
        // L·∫•y gi√° tr·ªã t·ª´ c√°c √¥ input.
        myUserId = parseInt(myUserIdInput.value, 10)
        toUserId = parseInt(toUserIdInput.value, 10)

        if (!myUserId || !toUserId) {
          alert('Vui l√≤ng nh·∫≠p c·∫£ hai User ID.')
          return
        }

        // --- Lu·ªìng ch√≠nh ---
        // 1. Thay ƒë·ªïi giao di·ªán: ·∫©n form ƒëƒÉng nh·∫≠p, hi·ªán khung chat.
        authContainer.style.display = 'none'
        chatContainer.style.display = 'flex'
        chatTitle.innerText = `Chat v·ªõi User ${toUserId}`

        // 2. T·∫£i l·ªãch s·ª≠ chat t·ª´ API.
        const history = await fetchChatHistory(toUserId)
        chatBox.innerHTML = '' // X√≥a s·∫°ch khung chat tr∆∞·ªõc khi hi·ªÉn th·ªã l·ªãch s·ª≠.
        history.forEach(displayMessage) // Hi·ªÉn th·ªã t·ª´ng tin nh·∫Øn trong l·ªãch s·ª≠.
        scrollToBottom() // Cu·ªôn xu·ªëng cu·ªëi.

        // 3. Sau khi t·∫£i xong l·ªãch s·ª≠, m·ªõi k·∫øt n·ªëi WebSocket ƒë·ªÉ nh·∫≠n tin m·ªõi.
        connectWebSocket()
      })

      // G·∫Øn s·ª± ki·ªán 'submit' cho form chat ƒë·ªÉ g·ª≠i tin nh·∫Øn.
      chatForm.addEventListener('submit', (e) => {
        e.preventDefault() // NgƒÉn trang reload.
        const content = messageInput.value
        // N·∫øu c√≥ n·ªôi dung v√† ƒë√£ k·∫øt n·ªëi socket th√¨ g·ª≠i tin nh·∫Øn.
        if (content.trim() && socket) {
          socket.emit('sendMessage', { toUserId: toUserId, content: content })
          messageInput.value = '' // X√≥a n·ªôi dung trong √¥ input.
        }
      })
    </script>
  </body>
</html>
